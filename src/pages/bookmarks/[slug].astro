---
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";
import Base from "$layouts/Base.astro";
import { truncateWords } from "$utils/text";

export const getStaticPaths = (async () => {
  const bookmarks = await getCollection("bookmarks");
  return bookmarks.map((bookmark) => ({ params: { slug: bookmark.slug }, props: { bookmark } }));
}) satisfies GetStaticPaths;

const { bookmark } = Astro.props;
const { Content } = await bookmark.render();

const description = bookmark.body ? truncateWords(bookmark.body, 40) : `Bookmark: ${bookmark.data.title}`;
const dateStr = bookmark.data.date.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });

const allBookmarks = (await getCollection("bookmarks")).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const currentIndex = allBookmarks.findIndex((b) => b.slug === bookmark.slug);
const prevBookmark = currentIndex < allBookmarks.length - 1 ? allBookmarks[currentIndex + 1] : null;
const nextBookmark = currentIndex > 0 ? allBookmarks[currentIndex - 1] : null;
---

<Base title={`${bookmark.data.title} — Bookmarks — Owais Jamil`} description={description} ogImage="/og/page/home.png">
  <article>
    <header class="mb-8 pb-6 border-b-2 border-dotted border-line">
      <h1 class="text-3xl md:text-4xl text-cyan mb-4">{bookmark.data.title}</h1>
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-baseline text-muted mb-5 gap-2">
        <time datetime={bookmark.data.date.toISOString()}>{dateStr}</time>
        <a href={bookmark.data.url} target="_blank" rel="noopener noreferrer" class="text-cyan hover:underline">
          Visit Site ↗
        </a>
      </div>
      {
        bookmark.data.categories.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {bookmark.data.categories.map((category) => (
              <a href={`/tags/${category}`} class="tag">
                {category}
              </a>
            ))}
          </div>
        )
      }
    </header>

    {
      bookmark.body && (
        <div data-prose class="mb-10">
          <Content />
        </div>
      )
    }

    <nav aria-label="Bookmark navigation" class="pt-8 border-t-2 border-dotted border-line">
      <div class="flex flex-col sm:flex-row sm:justify-between gap-4 mb-4">
        {
          prevBookmark && (
            <a href={`/bookmarks/${prevBookmark.slug}/`} class="text-muted hover:text-cyan hover:underline max-w-full sm:max-w-3xs">
              ← {prevBookmark.data.title}
            </a>
          )
        }
        {
          nextBookmark && (
            <a href={`/bookmarks/${nextBookmark.slug}/`} class="text-muted hover:text-cyan hover:underline text-right max-w-full sm:max-w-3xs">
              {nextBookmark.data.title} →
            </a>
          )
        }
      </div>
      <a href="/bookmarks" class="text-cyan hover:underline">← All Bookmarks</a>
    </nav>
  </article>
</Base>
