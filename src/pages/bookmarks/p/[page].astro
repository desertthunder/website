---
import { getCollection } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import type { CollectionEntry } from "astro:content";
import Base from "$layouts/Base.astro";
import BookmarkCard from "$components/BookmarkCard.astro";

type Props = { page: Page<CollectionEntry<"bookmarks">> };

export const getStaticPaths = (async ({ paginate }) => {
  const bookmarks = (await getCollection("bookmarks")).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  return paginate(bookmarks, { pageSize: 4 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const categoryMap = new Map<string, number>();
const yearMap = new Map<number, number>();

for (const bookmark of page.data) {
  bookmark.data.categories.forEach((category) => {
    categoryMap.set(category, (categoryMap.get(category) || 0) + 1);
  });
}

const categories = Array.from(categoryMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));

for (const bookmark of page.data) {
  const year = bookmark.data.date.getFullYear();
  yearMap.set(year, (yearMap.get(year) || 0) + 1);
}

const years = Array.from(yearMap.entries()).sort((a, b) => b[0] - a[0]);
---

<Base title="Bookmarks — Owais Jamil" ogImage="/og/page/home.png">
  <section>
    <h2 class="text-3xl md:text-4xl text-cyan mb-8">Bookmarks</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      {
        page.data.map((bookmark) => (
          <BookmarkCard
            slug={bookmark.slug}
            title={bookmark.data.title}
            url={bookmark.data.url}
            date={bookmark.data.date}
            categories={bookmark.data.categories}
            content={bookmark.body}
          />
        ))
      }
    </div>

    {
      (categories.length > 0 || years.length > 0) && (
        <div class="mb-8 pb-6">
          {categories.length > 0 && (
            <div class="mb-6">
              <span class="text-muted font-semibold block mb-3">Categories</span>
              <div class="flex flex-wrap gap-2">
                {categories.map(([category, count]) => (
                  <a href={`/tags/${category}`} class="tag">
                    {category} ({count})
                  </a>
                ))}
              </div>
            </div>
          )}

          {years.length > 0 && (
            <div>
              <span class="text-muted font-semibold block mb-3">Years</span>
              <div class="flex flex-wrap gap-2">
                {years.map(([year, count]) => (
                  <a href={`/bookmarks/${year}`} class="tag">
                    {year} ({count})
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      )
    }

    <nav class="pagination" aria-label="Bookmarks pagination">
      <div class="links">
        {
          page.url.prev && (
            <a href={page.url.prev} class="link" data-nav="prev">
              ← Previous
            </a>
          )
        }
        <span class="info">
          Page {page.currentPage} of {page.lastPage}
        </span>
        {
          page.url.next && (
            <a href={page.url.next} class="link" data-nav="next">
              Next →
            </a>
          )
        }
      </div>
    </nav>
  </section>
</Base>

<script>
  document.addEventListener("keydown", (e) => {
    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
      return;
    }

    const prevLink = document.querySelector<HTMLAnchorElement>('a[data-nav="prev"]');
    const nextLink = document.querySelector<HTMLAnchorElement>('a[data-nav="next"]');

    if (e.key === "ArrowLeft") {
      prevLink?.click();
    } else if (e.key === "ArrowRight") {
      nextLink?.click();
    } else if (e.key === "[" && document.activeElement?.tagName !== "INPUT") {
      const handleSecondBracket = (e2: KeyboardEvent) => {
        if (e2.key === "[") {
          prevLink?.click();
        }
        document.removeEventListener("keydown", handleSecondBracket);
      };
      document.addEventListener("keydown", handleSecondBracket);
      setTimeout(() => document.removeEventListener("keydown", handleSecondBracket), 500);
    } else if (e.key === "]" && document.activeElement?.tagName !== "INPUT") {
      const handleSecondBracket = (e2: KeyboardEvent) => {
        if (e2.key === "]") {
          nextLink?.click();
        }
        document.removeEventListener("keydown", handleSecondBracket);
      };
      document.addEventListener("keydown", handleSecondBracket);
      setTimeout(() => document.removeEventListener("keydown", handleSecondBracket), 500);
    }
  });
</script>
