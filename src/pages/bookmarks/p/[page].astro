---
import { getCollection } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import type { CollectionEntry } from "astro:content";
import Base from "$layouts/Base.astro";
import BookmarkCard from "$components/BookmarkCard.astro";
import Paginator from "$components/Paginator.astro";

type Props = { page: Page<CollectionEntry<"bookmarks">>; allCategories: [string, number][] };

export const getStaticPaths = (async ({ paginate }) => {
  const bookmarks = (await getCollection("bookmarks")).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  const allCategoryMap = new Map<string, number>();
  for (const bookmark of bookmarks) {
    bookmark.data.categories.forEach((category) => {
      allCategoryMap.set(category, (allCategoryMap.get(category) || 0) + 1);
    });
  }
  const allCategories = Array.from(allCategoryMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));

  return paginate(bookmarks, { pageSize: 4, props: { allCategories } });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

page.url.first = "/bookmarks";
if (page.currentPage === 2) {
  page.url.prev = "/bookmarks";
}
const { allCategories } = Astro.props;
const categoryMap = new Map<string, number>();
const yearMap = new Map<number, number>();

for (const bookmark of page.data) {
  bookmark.data.categories.forEach((category) => {
    categoryMap.set(category, (categoryMap.get(category) || 0) + 1);
  });
}

const currentCategories = Array.from(categoryMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));

for (const bookmark of page.data) {
  const year = bookmark.data.date.getFullYear();
  yearMap.set(year, (yearMap.get(year) || 0) + 1);
}

const years = Array.from(yearMap.entries()).sort((a, b) => b[0] - a[0]);
---

<Base title="Bookmarks â€” Owais Jamil" ogImage="/og/page/home.png">
  <section>
    <h2 class="text-3xl md:text-4xl text-cyan mb-8">Bookmarks</h2>
    <div class="space-y-6 mb-8">
      {
        page.data.map((bookmark) => (
          <BookmarkCard
            slug={bookmark.slug}
            title={bookmark.data.title}
            url={bookmark.data.url}
            date={bookmark.data.date}
            categories={bookmark.data.categories}
            content={bookmark.body}
          />
        ))
      }
    </div>

    {
      (currentCategories.length > 0 || allCategories.length > 0 || years.length > 0) && (
        <div class="mb-8 pb-6">
          {currentCategories.length > 0 && (
            <div class="mb-6">
              <span class="text-muted font-medium font-serif block mb-3">Current Categories</span>
              <div class="flex flex-wrap gap-2">
                {currentCategories.map(([category, count]) => (
                  <a href={`/tags/${category}`} class="tag">
                    {category} ({count})
                  </a>
                ))}
              </div>
            </div>
          )}

          {allCategories.length > 0 && (
            <div class="mb-6">
              <span class="text-muted font-medium font-serif block mb-3">All Categories</span>
              <div class="flex flex-wrap gap-2">
                {allCategories.map(([category, count]) => (
                  <a href={`/tags/${category}`} class="tag">
                    {category} ({count})
                  </a>
                ))}
              </div>
            </div>
          )}

          {years.length > 0 && (
            <div>
              <span class="text-muted font-medium font-serif block mb-3">Years</span>
              <div class="flex flex-wrap gap-2">
                {years.map(([year, count]) => (
                  <a href={`/bookmarks/${year}`} class="tag">
                    {year} ({count})
                  </a>
                ))}
              </div>
            </div>
          )}
        </div>
      )
    }

    <Paginator page={page} label="Bookmark Pagination" />
  </section>
</Base>

<script>
  import { setupPaginationNavigation } from "$utils/pagination";

  setupPaginationNavigation();
</script>
