---
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";
import Base from "$layouts/Base.astro";
import Terminal from "$components/Terminal.astro";
import Command from "$components/Command.astro";
import Output from "$components/Output.astro";
import { calculateReadingTime } from "$utils/reading-time";
import "$styles/prose.css";
import Token from "$components/Token.astro";

export const getStaticPaths = (async () => {
  const posts = await getCollection("blog");
  return posts.map((post) => ({ params: { slug: post.slug }, props: { post } }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content } = await post.render();
const dateStr = post.data.date.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });

const readingTime = calculateReadingTime(post.body);
const allPosts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const currentIndex = allPosts.findIndex((p) => p.slug === post.slug);
const prevPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const ogImage = `/og/${post.slug}.png`;
const hasTags = post.data.tags.length > 0;
---

<Base title={`${post.data.title} — Owais Jamil`} description={post.data.description} ogImage={ogImage}>
  <Terminal title={`blog/${post.slug}`}>
    <Command><Token color="blue">cat</Token> ~/blog/{post.slug}.md</Command>
    <Output>
      <header>
        <h2>{post.data.title}</h2>
        <section>
          <time datetime={post.data.date.toISOString()}>{dateStr}</time>
          <span class="reading-time">{readingTime}</span>
        </section>
        {
          hasTags && (
            <section>
              {post.data.tags.map((tag) => (
                <a href={`/tags/${tag}`}>{tag}</a>
              ))}
            </section>
          )
        }
      </header>

      <article data-prose>
        <Content />
      </article>

      <nav aria-label="Post navigation">
        <div>
          {
            prevPost && (
              <a href={`/blog/${prevPost.slug}/`} data-nav="prev">
                <span>← Previous</span>
                <span>{prevPost.data.title}</span>
              </a>
            )
          }
        </div>
        <div>
          {
            nextPost && (
              <a href={`/blog/${nextPost.slug}/`} data-nav="next">
                <span>Next →</span>
                <span>{nextPost.data.title}</span>
              </a>
            )
          }
        </div>
      </nav>
    </Output>
  </Terminal>
</Base>

<script>
  document.addEventListener("keydown", (e) => {
    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
      return;
    }

    const prevLink = document.querySelector<HTMLAnchorElement>('a[data-nav="prev"]');
    const nextLink = document.querySelector<HTMLAnchorElement>('a[data-nav="next"]');

    if (e.key === "ArrowLeft") {
      prevLink?.click();
    } else if (e.key === "ArrowRight") {
      nextLink?.click();
    } else if (e.key === "[" && document.activeElement?.tagName !== "INPUT") {
      const handleSecondBracket = (e2: KeyboardEvent) => {
        if (e2.key === "[") {
          prevLink?.click();
        }

        document.removeEventListener("keydown", handleSecondBracket);
      };

      document.addEventListener("keydown", handleSecondBracket);

      setTimeout(() => document.removeEventListener("keydown", handleSecondBracket), 500);
    } else if (e.key === "]" && document.activeElement?.tagName !== "INPUT") {
      const handleSecondBracket = (e2: KeyboardEvent) => {
        if (e2.key === "]") {
          nextLink?.click();
        }

        document.removeEventListener("keydown", handleSecondBracket);
      };

      document.addEventListener("keydown", handleSecondBracket);

      setTimeout(() => document.removeEventListener("keydown", handleSecondBracket), 500);
    }
  });
</script>

<style>
  @reference "../../styles/global.css";

  header {
    @apply mb-8 pb-4 border-b border-line border-dotted;
  }

  header h2 {
    @apply text-cyan mr-2 text-2xl font-medium;
  }

  header > *:nth-child(2) {
    @apply flex items-center gap-4 text-muted;
  }

  header > *:nth-child(2) span::before {
    content: "• ";
  }

  header > *:nth-child(3) {
    @apply mt-4 flex gap-2 flex-wrap;
  }

  header > *:nth-child(3) a {
    background: color-mix(in oklab, var(--panel), black 8%);
    @apply text-green px-3 py-2 rounded-sm text-sm border border-line border-dotted no-underline duration-300;
    @apply hover:bg-panel hover:border-green hover:no-underline;
  }

  nav {
    @apply mt-12 pt-8 border-t border-line border-dotted grid grid-cols-2 gap-8;
    @apply nth-[2]:text-right;
  }

  nav div {
    @apply min-w-0;
  }

  nav a {
    background: color-mix(in oklab, var(--panel), black 8%);
    @apply grid grid-cols-1 md:flex md:flex-col gap-1 text-cyan no-underline p-4 border border-dotted border-line rounded-sm duration-300;
    @apply hover:bg-panel hover:border-cyan hover:no-underline;
  }

  nav div a span:first-child {
    @apply text-sm text-muted font-semibold;
  }

  nav div a span:last-child {
    @apply max-md:text-left text-cyan overflow-hidden text-ellipsis whitespace-nowrap;
  }
</style>
