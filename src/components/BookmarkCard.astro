---
import { truncate, truncateWords } from "$utils/text";

type Props = { slug: string; title: string; url: string; date: Date; categories: string[]; content?: string };

const { slug, title, url, date, categories, content } = Astro.props;
const dateStr = date.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
const displayTitle = truncate(title, 60);
const displayContent = content ? truncateWords(content, 60) : undefined;
const initialCategories = categories.slice(0, 2);
const hiddenCategories = categories.slice(2);
---

<article data-card>
  <header>
    <h3>
      <a href={`/bookmarks/${slug}/`} class="title-link" title={`View ${displayTitle}`}>
        {displayTitle}
      </a>
    </h3>
    <time datetime={date.toISOString()}>{dateStr}</time>
  </header>
  {displayContent && <p>{displayContent}</p>}
  <a href={url} target="_blank" rel="noopener noreferrer" title={url}>
    {url}
  </a>
  {
    categories.length > 0 && (
      <div class="categories" data-expanded="false">
        {initialCategories.map((category) => (
          <a href={`/tags/${encodeURIComponent(category)}/`} class="category" data-category={category}>
            {category}
          </a>
        ))}
        {hiddenCategories.map((category) => (
          <a
            href={`/tags/${encodeURIComponent(category)}/`}
            class="category is-hidden"
            data-hidden
            data-category={category}>
            {category}
          </a>
        ))}
        {hiddenCategories.length > 0 && (
          <button type="button" class="category toggle" data-toggle aria-expanded="false">
            <span aria-hidden="true">...</span>
            <span class="sr-only">Show all tags</span>
          </button>
        )}
      </div>
    )
  }
</article>

<script>
  import { setupTagToggles } from "$utils/tag-toggle";
  setupTagToggles();
</script>

<style>
  @reference "../styles/global.css";

  header {
    @apply m-0 flex-wrap;
  }

  header h3 {
    @apply flex-1 min-w-0;
  }

  header h3 a {
    @apply line-clamp-1 text-ellipsis;
  }

  p {
    @apply line-clamp-3 text-ellipsis px-0 py-1;
  }

  a[target="_blank"] {
    @apply block text-muted text-sm whitespace-nowrap text-ellipsis px-4 py-0;
    @apply hover:underline hover:underline-offset-1;
  }

  .categories {
    @apply mt-auto pt-3;
  }

  .category {
    @apply text-yellow hover:border-yellow;
  }
</style>
