---
import BaseCard from "./BaseCard.astro";
import { truncate } from "$utils/text";

type Props = { slug: string; title: string; url: string; date: Date; categories: string[]; content?: string };

const { slug, title, url, date, categories, content } = Astro.props;
const dateStr = date.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
const displayTitle = truncate(title, 80);

let displayContent: string | undefined;
if (content) {
  const plainText = content
    .replace(/!\[.*?\]\(.*?\)/g, "")
    .replace(/\[([^\]]+)\]\(.*?\)/g, "$1")
    .replace(/#{1,6}\s+/g, "")
    .replace(/[*_]{1,3}([^*_]+)[*_]{1,3}/g, "$1")
    .replace(/`([^`]+)`/g, "$1")
    .replace(/```[\s\S]*?```/g, "")
    .replace(/>\s+/g, "")
    .replace(/[-*+]\s+/g, "")
    .replace(/\d+\.\s+/g, "")
    .replace(/\n\n+/g, " ")
    .replace(/\n/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  const sentenceMatch = plainText.match(/^[^.!?]+[.!?]+/);
  if (sentenceMatch) {
    displayContent = sentenceMatch[0].trim();
  } else {
    const maxLength = 150;
    displayContent = plainText.length > maxLength ? plainText.slice(0, maxLength).trim() + "..." : plainText;
  }
}

const initialCategories = categories.slice(0, 3);
const hiddenCategories = categories.slice(3);
---

<BaseCard>
  <a href={`/bookmarks/${slug}/`} slot="header">
    <h2 class="text-4xl">{displayTitle}</h2>
  </a>
  <time datetime={date.toISOString()} slot="header">{dateStr}</time>

  {displayContent && <p>{displayContent}</p>}

  {
    categories.length > 0 && (
      <div class="categories" data-expanded="false" slot="categories">
        {initialCategories.map((category) => (
          <a href={`/tags/${encodeURIComponent(category)}/`} class="category" data-category={category}>
            {category}
          </a>
        ))}
        {hiddenCategories.map((category) => (
          <a
            href={`/tags/${encodeURIComponent(category)}/`}
            class="category is-hidden"
            data-hidden
            data-category={category}>
            {category}
          </a>
        ))}
        {hiddenCategories.length > 0 && (
          <button type="button" class="category toggle" data-toggle aria-expanded="false">
            <span aria-hidden="true">...</span>
            <span class="sr-only">Show all categories</span>
          </button>
        )}
      </div>
    )
  }

  <a href={url} target="_blank" rel="noopener noreferrer" slot="footer" title={url} class="font-serif text-xl">
    Visit Link â†’
  </a>
</BaseCard>

<script>
  import { setupTagToggles } from "$utils/tag-toggle";
  setupTagToggles();
</script>

<style>
  @reference "../styles/global.css";

  article p {
    word-break: break-word;
  }

  .categories {
    @apply mt-auto pt-2;
  }

  .category {
    @apply text-yellow hover:border-yellow;
  }
</style>
