---
import { truncate, truncateWords } from "$utils/text";

type Props = { slug: string; title: string; url: string; date: Date; categories: string[]; content?: string };

const { slug, title, url, date, categories, content } = Astro.props;
const dateStr = date.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
const displayTitle = truncate(title, 60);
const displayContent = content ? truncateWords(content, 60) : undefined;
const initialCategories = categories.slice(0, 2);
const hiddenCategories = categories.slice(2);
---

<article class="tui-card" data-bookmark={slug}>
  <div class="card-body" data-card role="link" tabindex="0" aria-label={`View bookmark: ${displayTitle}`}>
    <header>
      <h3 class="title">
        <a href={url} class="title-link" target="_blank" rel="noopener noreferrer" title={`Open ${displayTitle}`}>
          {displayTitle}
        </a>
      </h3>
      <time datetime={date.toISOString()} class="date">{dateStr}</time>
    </header>
    {displayContent && <p class="content">{displayContent}</p>}
    <a href={url} class="url" target="_blank" rel="noopener noreferrer" title={url}>
      {url}
    </a>
    {
      categories.length > 0 && (
        <div class="categories" data-expanded="false">
          {initialCategories.map((category) => (
            <a href={`/tags/${encodeURIComponent(category)}/`} class="category" data-category={category}>
              {category}
            </a>
          ))}
          {hiddenCategories.map((category) => (
            <a
              href={`/tags/${encodeURIComponent(category)}/`}
              class="category is-hidden"
              data-hidden
              data-category={category}>
              {category}
            </a>
          ))}
          {hiddenCategories.length > 0 && (
            <button type="button" class="category toggle" data-toggle aria-expanded="false">
              <span aria-hidden="true">…</span>
              <span class="sr-only">Show all tags</span>
            </button>
          )}
        </div>
      )
    }
  </div>
</article>

<script>
  const scriptEl = document.currentScript;
  const article = scriptEl?.previousElementSibling as HTMLElement | null;

  if (!article) {
    console.warn("BookmarkCard script could not locate its host article.");
    return;
  }

  const cardBody = article.querySelector<HTMLDivElement>("[data-card]");
  const categories = cardBody?.querySelector<HTMLDivElement>(".categories");
  const toggle = categories?.querySelector<HTMLButtonElement>("[data-toggle]");

  if (categories && toggle) {
    const visualLabel = toggle.querySelector<HTMLSpanElement>('[aria-hidden="true"]');
    const srLabel = toggle.querySelector<HTMLSpanElement>(".sr-only");

    toggle.addEventListener("click", (event) => {
      event.stopPropagation();
      const expanded = categories.dataset.expanded === "true";
      const nextExpanded = !expanded;
      categories.dataset.expanded = nextExpanded ? "true" : "false";
      toggle.setAttribute("aria-expanded", nextExpanded ? "true" : "false");
      if (visualLabel) {
        visualLabel.textContent = nextExpanded ? "−" : "…";
      }
      if (srLabel) {
        srLabel.textContent = nextExpanded ? "Hide tags" : "Show all tags";
      }
    });
  }

  const slug = article.dataset.bookmark;

  if (cardBody && slug) {
    const navigateToDetail = () => {
      window.location.href = `/bookmarks/${slug}/`;
    };

    cardBody.addEventListener("click", (event) => {
      const target = event.target as HTMLElement;
      if (target.closest("a, button")) {
        return;
      }
      const selection = window.getSelection();
      if (selection && selection.toString().trim().length > 0) {
        return;
      }
      navigateToDetail();
    });

    cardBody.addEventListener("keydown", (event) => {
      if (event.defaultPrevented) {
        return;
      }
      if (event.key === "Enter" || event.key === " ") {
        const target = event.target as HTMLElement;
        if (target.closest("a, button")) {
          return;
        }
        event.preventDefault();
        navigateToDetail();
      }
    });
  }
</script>

<style>
  .tui-card {
    margin: 1.5rem 0;
    background: var(--panel);
    border: 2px dashed var(--line);
    border-radius: 4px;
    transition:
      border-color 0.2s,
      box-shadow 0.2s;
    display: flex;
    flex-direction: column;
  }

  .tui-card:hover {
    border-color: var(--cyan);
    box-shadow: 0 2px 12px rgba(137, 184, 194, 0.15);
  }

  .card-body {
    flex: 1 1 auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    cursor: pointer;
  }

  .card-body:focus-visible {
    outline: 2px solid var(--cyan);
    outline-offset: 2px;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    margin: 0;
    flex-wrap: nowrap;
    padding-bottom: 0.5rem;
    border-bottom: 1px dotted var(--line);
  }

  .title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    flex: 1 1 auto;
    min-width: 0;
    color: var(--cyan);
  }

  .title-link {
    color: inherit;
    text-decoration: none;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .card-body:hover .title-link,
  .title-link:focus-visible {
    text-decoration: underline;
    text-underline-offset: 0.2em;
  }

  .date {
    color: var(--muted);
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .content {
    color: var(--fg);
    margin: 0;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .url {
    display: block;
    color: var(--muted);
    font-size: 0.85rem;
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .url:hover,
  .url:focus-visible {
    text-decoration: underline;
    text-underline-offset: 0.2em;
  }

  .categories {
    margin-top: auto;
    padding-top: 0.75rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .category {
    background: color-mix(in oklab, var(--panel), black 8%);
    color: var(--yellow);
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    border: 1px dotted var(--line);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    transition:
      background 0.2s,
      border-color 0.2s;
  }

  .tui-card:hover .category {
    background: var(--panel);
    border-color: var(--yellow);
  }

  .category.toggle {
    cursor: pointer;
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2rem;
  }

  .category.is-hidden {
    display: none;
  }

  .categories[data-expanded="true"] .category.is-hidden {
    display: inline-flex;
  }

  .categories[data-expanded="true"] .category.toggle span[aria-hidden="true"] {
    font-size: 1rem;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
